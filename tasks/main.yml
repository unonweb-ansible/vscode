---
- name: vscode role
  tags:
    - vscode
  block:
  
  # mkdir
  - name: Make sure directory /etc/apt/keyrings exists
    become: true
    ansible.builtin.file:
      path: "/etc/apt/keyrings"
      mode: u=rwx,g=rx,o=rx
      state: directory
      
  # repo key
  - name: Copy repo key
    become: true
    ansible.builtin.copy:
      src: microsoft-vscode.gpg
      dest: "/etc/apt/keyrings/microsoft-vscode.gpg"
      owner: root
      group: root
      mode: u=rw,g=r,o=r

  # repo file
  - name: Copy microsoft repo file
    become: true
    ansible.builtin.copy:
      src: microsoft-vscode.list
      dest: /etc/apt/sources.list.d/microsoft-vscode.list
      owner: root
      group: root
      mode: u=rw,g=r,o=r
    register: __vscode_repo
  
  # apt-update
  - when: __vscode_repo.changed
    name: Update apt cache
    become: true
    ansible.builtin.apt:
      update_cache: true
  
  # install
  - name: Install vscode
    become: true
    ansible.builtin.apt:
      state: present
      name: code
  
  # vscode.config.settings
  - when: vscode_settings != None
    name: Copy {{ vscode_settings }}
    become: true
    ansible.builtin.copy:
      src: "{{ vscode_settings }}"
      dest: "/home/{{ vscode_user }}/.config/Code/User/settings.json"
      owner: "{{ vscode_user }}"
      group: "{{ vscode_user }}"
      mode: u=rw,g=,o=

  # vscode.config.settings
  - when: vscode_keybindings != None
    name: Copy {{ vscode_keybindings }}
    become: true
    ansible.builtin.copy:
      src: "{{ vscode_keybindings }}"
      dest: "/home/{{ vscode_user }}/.config/Code/User/keybindings.json"
      owner: "{{ vscode_user }}"
      group: "{{ vscode_user }}"
      mode: u=rw,g=,o=
